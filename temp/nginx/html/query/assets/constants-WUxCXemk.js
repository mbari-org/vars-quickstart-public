import{K as p,j as k,h as N,c as g}from"./index-WXnswS6Z.js";import{b as w,e as A,t as b}from"./util-C4ZhWDef.js";class L{annotation;constructor(n){this.annotation=n}hasValidPosition(){return"latitude"in this.annotation&&"longitude"in this.annotation&&!isNaN(this.latitude)&&!isNaN(this.longitude)&&this.latitude<90&&this.latitude>-90&&this.longitude<180&&this.longitude>-180}get concept(){return this.annotation.concept??""}get latitude(){return this.annotation.latitude??NaN}get longitude(){return this.annotation.longitude??NaN}}function q(e,n){if(e&&e.length>0){const i=e.map(o=>o.latitude).filter(o=>o!==void 0&&!isNaN(o)&&o!==0),s=Math.min(...i),m=Math.max(...i),l=e.map(o=>o.longitude).filter(o=>o!==void 0&&!isNaN(o)&&o!==0),t=Math.min(...l),r=Math.max(...l);if(s&&t&&m&&r)return{minLat:s,maxLat:m,minLon:t,maxLon:r}}return n}function R(e,n){return e?[[e.minLat,e.minLon],[e.maxLat,e.maxLon]]:R(n,n)}function S(e){if(e.length===0)return[];const n=w(e,m=>m.observation_uuid??""),i=[];let s=0;for(const[m,l]of n){const t={row:s,...JSON.parse(JSON.stringify(l[0]))};s+=1,delete t.image_description,delete t.image_format,delete t.image_height,delete t.image_reference_uuid,delete t.image_url,delete t.image_width,delete t.link_name,delete t.link_value,delete t.to_concept,delete t.associations;const r=l.map(a=>({uuid:a.image_reference_uuid,description:a.image_description,format:a.image_format,height_pixels:a.image_height,url:a.image_url,width_pixels:a.image_width}))||[];p.uniqBy(r.filter(h),a=>a.url).length>0&&(t.images=p.uniqBy(r.filter(h),a=>a.url));const u=l.map(a=>{const d={uuid:a.image_reference_uuid,link_name:a.link_name,link_value:a.link_value,to_concept:a.to_concept,media_type:a.association_mime_type},_=a.associations?.split("|").map(f=>f.trim());return _&&_.length>0&&(d.link_name=_[0],d.to_concept=_[1],d.link_value=_[2]),d})||[],c=p.uniqBy(u.filter(T),y);c.length>0&&(t.details=c),i.push(t)}return i}function y(e){const n=e.link_name??"",i=e.to_concept??"",s=e.link_value??"";return`${n} | ${i} | ${s}`}function Q(e,n){const i=y(e);return i.length>n?i.substring(0,n)+"...":i}function T(e){return!!(e.link_name?.trim()||e.to_concept?.trim()||e.link_value?.trim())}function h(e){return!!e.url?.trim()}function M(e){const n=e.images?.map(i=>i.url??"");return A(n)??null}function O(e){const n={};for(const i in e)if(e.hasOwnProperty(i)){const s=e[i];typeof s=="string"&&["altitude","depth_meters","duration_millis","frame_rate","index_elapsed_time_millis","latitude","longitude","oxygen_ml_per_l","phi","pressure_dbar","psi","row","salinity","temperature_celsius","theta","video_duration_millis","video_height","video_size_bytes","video_width","x","y","z"].includes(i)?n[i]=parseFloat(s):n[i]=s}return n}function v(e){if(p.isString(e?.trim())){const n=e?.trim()?.toLowerCase();return n!=="self"&&n!=="nil"}return!1}function F(e){const n=v(e.to_concept??""),i=v(e.link_value??"");return n&&i?`${e.to_concept} | ${e.link_value}`:n?`${e.to_concept}`:i?`${e.link_value}`:""}function $(e){if(e.length===0)return"";const n=Array.from(new Set(e.flatMap(t=>(t.details??[]).map(r=>r.link_name).filter(r=>!!r)))),s=[...Object.keys(e[0]).filter(t=>t!=="details"),...n],m=s.join("	"),l=e.map(t=>{const r={};for(const u of t.details??[])u.link_name&&(r[u.link_name]=F(u));return s.map(u=>{if(n.includes(u))return r[u]??"";const c=t[u];return u==="images"&&c?c.map(a=>a.url).join(";"):Array.isArray(c)?c.join(";"):c??""}).join("	")});return[m,...l].join(`
`)}const B=k("query-results",()=>{const e=N([]),n=g(()=>b(e.value)),i=g(()=>S(n.value).map((t,r)=>{const o=O(t),u=M(o),c=t.concept,a=t.video_sequence_name,d=t.index_recorded_timestamp,_=t.depth_meters,f=t.observer,x=t.details;return delete o.concept,delete o.video_sequence_name,delete o.index_recorded_timestamp,delete o.depth_meters,delete o.observer,delete o.details,{image:u,concept:c,video_sequence_name:a,index_recorded_timestamp:d,depth_meters:_,observer:f,details:x,...o,row:r}})),s=g(()=>i.value.map(t=>new L(t)));function m(){e.value=[]}function l(t){e.value=e.value.concat(t)}return{rawQueryResults:e,queryResults:n,annotations:i,geoAnnotations:s,reset:m,appendRawQueryResults:l}}),V=15e3,E=25e3;export{L as G,V as M,E as Q,Q as a,y as b,$ as c,R as f,q as g,B as u};

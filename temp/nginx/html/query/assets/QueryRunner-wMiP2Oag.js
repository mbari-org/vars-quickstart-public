import{J as f,j as c,G as w,c as p,H as O,k as d,K as E,h as l}from"./index-WXnswS6Z.js";import{u as W,Q as J}from"./constants-WUxCXemk.js";function M(n){const e=[];return n.forEach(t=>D(t,e)),[...new Set(e)].sort()}function D(n,e=[]){return e.push(n.name),e.push(...n.alternativeNames||[]),n.children&&n.children.forEach(t=>D(t,e)),e}function v(n){const e=n.reduce((t,s)=>_(s,t),[]);return[...new Set(e)].sort()}function _(n,e){return e.push(n.name),e.push(...n.alternateNames||[]),e}function z(n){if(n){const e=f.sortBy(n,t=>t.name);return f.sortedUniqBy(e,t=>t.name)}return n}const b=["dsg-depth-distribution","dsg-range"],S=["dsg-size","dsg-color","dsg-shape","dsg-description"],N=["dsg-reference"],T=["dsg-consulting-taxonomist"];function V(n){return n?n.map(e=>{let t=e.linkName;return e.linkName.startsWith("dsg-")&&(t=e.linkName.substring(4)),{displayedName:t.split("-").join(" "),linkValue:e.linkValue,linkName:e.linkName,toConcept:e.toConcept}}):[]}function h(n,e){if(n&&n.descriptors){let t=n.descriptors.filter(s=>e(s));return t=f.sortBy(t,s=>s.linkName),V(t)}return[]}function F(n,e){n.forEach(t=>{e.has(t.linkName)&&(t.displayedName=e.get(t.linkName))})}class K{concept;constructor(e){this.concept=e}names(){const e=_(this.concept,[]);return[...new Set(e)].sort()}author(){const e=this.concept;if(e?.author){const t=e.author;return t?.startsWith("(")?t:`(${t})`}return""}primaryMedia(e){const t=this.concept;let s=e;if(t&&t.media&&t.media.length>0){const i=t.media.filter(r=>r.isPrimary);i.length>0&&(s=i[0].url)}return s}hasImages(){return this.concept&&this.concept.media&&this.concept.media.length>0}images(e=""){return this.hasImages()?this.concept.media.filter(t=>t.mimeType.startsWith("image")):e?[{url:e,caption:"",credit:"",isPrimary:!0,mimeType:""}]:[]}get consultingTaxonomists(){const e=h(this.concept,t=>T.includes(t.linkName));return f.sortBy(e,t=>t.linkValue)}get references(){const e=h(this.concept,t=>N.includes(t.linkName));return f.sortBy(e,t=>t.linkValue)}get descriptions(){return h(this.concept,e=>S.includes(e.linkName))}get geographicInfo(){const e=new Map([["dsg-range","Ocean range (global)"],["dsg-depth-distribution","Published depth range"]]),t=h(this.concept,s=>b.includes(s.linkName));return F(t,e),t}get otherDescriptions(){return h(this.concept,e=>!S.includes(e.linkName)&&!N.includes(e.linkName)&&!b.includes(e.linkName)&&!T.includes(e.linkName))}}class G{url;constructor(e){this.url=e}findTree(e){return this.treeUp(e)}findAllContaining(e){return fetch(this.url+"/concept/find/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json()).then(t=>z(t))}findByConceptName(e){return fetch(this.url+"/concept/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}findParentByConceptName(e){return fetch(this.url+"/concept/parent/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}findRepresentativeImagesByName(e,t=12){return fetch(this.url+"/dsg/images/representative/"+encodeURIComponent(e)+"?limit="+t,{mode:"cors"}).then(s=>s.json())}findSiblings(e){return fetch(this.url+"/phylogeny/siblings/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}listAllConcepts(){return fetch(this.url+"/concept",{mode:"cors"}).then(e=>e.json())}listAncestors(e){return fetch(this.url+"/phylogeny/basic/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}listChildren(e){return fetch(this.url+"/concept/children/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}listDescendants(e){return fetch(this.url+"/phylogeny/taxa/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}treeDown(e){return fetch(this.url+"/phylogeny/down/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}treeUp(e){return fetch(this.url+"/phylogeny/up/"+encodeURIComponent(e),{mode:"cors"}).then(t=>t.json())}accumulateNames(e,t=""){switch(t){case"parent":return this.findByConceptName(e).then(s=>this.findParentByConceptName(e).then(i=>v([s,i])));case"children":return this.findByConceptName(e).then(s=>this.listChildren(e).then(i=>(i.push(s),v(i))));case"siblings":return this.findByConceptName(e).then(s=>this.findSiblings(e).then(i=>(i.push(s),v(i))));case"descendants":return this.listDescendants(e).then(s=>M(s));default:return this.findByConceptName(e).then(s=>new K(s).names())}}listLinks(){return fetch(this.url+"/links",{mode:"cors"}).then(e=>e.json())}}const Z=c("oni",()=>{const n=w(),e=p(()=>O("oni",n.config)),t=p(()=>new G(e.value)),s=d(()=>t.value.listAllConcepts()),i=d(()=>t.value.listLinks().then(o=>o.filter(u=>!u.linkName.startsWith("dsg-")))),r=p(()=>E.uniq(i.value?.map(o=>o.linkName)).sort());return{url:e,api:t,concepts:s,links:i,linkNames:r}});function H(){const n=[],e=k().buildColumnConstraints(),t=C().buildColumnConstraints(),s=g().buildColumnConstraints(),i=Q().buildColumnConstraints(),r=A().buildColumnConstraints(),o=U().buildColumnConstraints(),u=L().buildColumnConstraints(),a=R().buildColumnConstraints(),m=P().buildColumnConstraints(),$=I().buildColumnConstraints(),B=y().buildColumnConstraints();return n.push(...e),n.push(...t),n.push(...s),n.push(...i),n.push(...r),n.push(...o),n.push(...u),n.push(...a),n.push(...m),n.push(...$),n.push(...B),n}function Y(){return q().buildSelect()}function ne(){Q().reset(),j().reset(),C().reset(),L().reset(),A().reset(),U().reset(),R().reset(),k().reset(),P().reset(),I().reset(),g().reset(),q().reset(),y().reset()}const k=c("selectedConcepts",()=>{const n=l([]),e=Z();function t(o,u){const a={concept:o,extendTo:u,conceptNames:[]};e.api.accumulateNames(o,u).then(m=>{a.conceptNames=m,n.value.push(a)})}function s(){n.value=[]}function i(o){n.value.splice(o,1)}function r(){if(n.value.length!==0){const o=[];return n.value.forEach(a=>{o.push(...a.conceptNames)}),[{column:"concept",in:Array.from(new Set(o))}]}return[]}return{selectedConcepts:n,add:t,remove:i,reset:s,buildColumnConstraints:r}}),j=c("association",()=>{const n=l([]),e=l(!1),t=l(!1);function s(u){n.value.push(u)}function i(){n.value=[]}function r(u){n.value.splice(u,1)}function o(){return n.value.length>0?e.value?n.value.map(u=>({column:"link_name",equals:u})):n.value.map(u=>({column:"associations",contains:u})):[]}return{associations:n,exactMatch:e,useAnd:t,add:s,remove:r,reset:i,buildColumnConstraints:o}}),g=c("videoSequenceName",()=>{const n=l([]),e=C();function t(){n.value=[]}function s(o){n.value.splice(o,1)}function i(o){e.reset(),n.value.push(o)}function r(){return n.value.length>0?[{column:"video_sequence_name",in:n.value}]:[]}return{videoSequenceNames:n,add:i,remove:s,reset:t,buildColumnConstraints:r}}),C=c("cameraPlatform",()=>{const n=l([]),e=g();function t(){n.value=[]}function s(o){n.value.splice(o,1)}function i(o){e.reset(),n.value.push(o)}function r(){return n.value.length>0?[{column:"camera_platform",in:n.value}]:[]}return{cameraPlatforms:n,add:i,remove:s,reset:t,buildColumnConstraints:r}}),Q=c("activities",()=>{const n=l([]);function e(){n.value=[]}function t(r){n.value.splice(r,1)}function s(r){n.value.push(r)}function i(){return n.value.length>0?[{column:"activity",in:n.value}]:[]}return{activities:n,add:s,remove:t,reset:e,buildColumnConstraints:i}}),A=c("groups",()=>{const n=l([]);function e(){n.value=[]}function t(r){n.value.splice(r,1)}function s(r){n.value.push(r)}function i(){return n.value.length>0?[{column:"observation_group",in:n.value}]:[]}return{groups:n,add:s,remove:t,reset:e,buildColumnConstraints:i}}),U=c("observers",()=>{const n=l([]);function e(){n.value=[]}function t(r){n.value.splice(r,1)}function s(r){n.value.push(r)}function i(){return n.value.length>0?[{column:"observer",in:n.value}]:[]}return{observers:n,add:s,remove:t,reset:e,buildColumnConstraints:i}}),L=c("chiefScientists",()=>{const n=l([]);function e(){n.value=[]}function t(r){n.value.splice(r,1)}function s(r){n.value.push(r)}function i(){return n.value.length>0?[{column:"chief_scientist",in:n.value}]:[]}return{chiefScientists:n,add:s,remove:t,reset:e,buildColumnConstraints:i}}),R=c("region",()=>{const n=l({minLatitude:null,maxLatitude:null,minLongitude:null,maxLongitude:null,minDepth:null,maxDepth:null});function e(){n.value={minLatitude:null,maxLatitude:null,minLongitude:null,maxLongitude:null,minDepth:null,maxDepth:null}}function t(o){n.value={...o}}function s(o){n.value.minDepth=o}function i(o){n.value.maxDepth=o}function r(){const o=[];return n.value.minLatitude!==void 0&&n.value.minLatitude!==null&&o.push({column:"latitude",min:n.value.minLatitude}),n.value.maxLatitude!==void 0&&n.value.maxLatitude!==null&&o.push({column:"latitude",max:n.value.maxLatitude}),n.value.minLongitude!==void 0&&n.value.minLongitude!==null&&o.push({column:"longitude",min:n.value.minLongitude}),n.value.maxLongitude!==void 0&&n.value.maxLongitude!==null&&o.push({column:"longitude",max:n.value.maxLongitude}),n.value.minDepth!==void 0&&n.value.minDepth!==null&&(console.log("minDepth",n.value.minDepth),o.push({column:"depth_meters",min:n.value.minDepth})),n.value.maxDepth!==void 0&&n.value.maxDepth!==null&&o.push({column:"depth_meters",max:n.value.maxDepth}),o}return{bounds:n,setBounds:t,reset:e,setMinDepth:s,setMaxDepth:i,buildColumnConstraints:r}}),P=c("time",()=>{const n=l({startTimestamp:null,endTimestamp:null});function e(){n.value={startTimestamp:null,endTimestamp:null}}function t(r){n.value.startTimestamp=r}function s(r){n.value.endTimestamp=r}function i(){let r=n.value.startTimestamp,o=n.value.endTimestamp;return r===null&&o===null?[]:(r||(r=new Date("1900-01-01T00:00:00Z")),o||(o=new Date(Date.now())),[{column:"index_recorded_timestamp",between:[r.toISOString(),o.toISOString()]}])}return{bounds:n,setStartTimestamp:t,setEndTimestamp:s,reset:e,buildColumnConstraints:i}}),I=c("observationTime",()=>{const n=l({startTimestamp:null,endTimestamp:null});function e(){n.value={startTimestamp:null,endTimestamp:null}}function t(r){n.value.startTimestamp=r}function s(r){n.value.endTimestamp=r}function i(){let r=n.value.startTimestamp,o=n.value.endTimestamp;return r===null&&o===null?[]:(r||(r=new Date("1900-01-01T00:00:00Z")),o||(o=new Date(Date.now())),[{column:"observation_timestamp",between:[r.toISOString(),o.toISOString()]}])}return{bounds:n,setStartTimestamp:t,setEndTimestamp:s,reset:e,buildColumnConstraints:i}}),q=c("selectedColumns",()=>{const n=["concept","depth_meters","image_url","imaged_moment_uuid","index_elapsed_time_millis","index_recorded_timestamp","latitude","longitude","observation_group","observation_uuid","observer","video_sequence_name","video_uri","associations"],e=l(n);function t(){s(n)}function s(r){e.value=r}function i(){return e.value}return{selectableColumns:e,setColumns:s,reset:t,buildSelect:i}}),y=c("decorators",()=>{const n=l(!1),e=l(!1),t=l(!0);function s(){return n.value?[{column:"image_url",isnull:!1}]:[]}function i(){n.value=!1,e.value=!1,t.value=!0}return{imagesOnly:n,concurrentObservations:e,relatedAssociations:t,reset:i,buildColumnConstraints:s}});function x(n){return Object.entries(n).filter(([,e])=>!!e).filter(([,e])=>typeof e!="object"||Array.isArray(e)||Object.keys(e).length>0).reduce((e,[t,s])=>({...e,[t]:s}),{})}class X{url;constructor(e){this.url=e}executeQueryWithTimeout(e,t){return fetch(e,{method:"POST",mode:"cors",body:JSON.stringify(x(t)),signal:AbortSignal.timeout(2e4)}).then(s=>s.json()).then(s=>s.content)}executeQuery(e,t){return fetch(e,{method:"POST",mode:"cors",body:JSON.stringify(x(t))}).then(s=>s.json()).then(s=>s.content)}compareAnnotations(e,t){let s=e.recorded_timestamp;s==null&&(s="1900-01-01T00:00:00Z");let i=t.recorded_timestamp;return i==null&&(i="1900-01-01T00:00:00Z"),s.localeCompare(i)}async pagedSearch(e,t){const s=[],i=await this.count(e),r=Math.ceil(i.count/t);for(let o=0;o<r;o++){e.limit=t,e.offset=t*o;const u=await this.search(e);s.push(...u)}return s.sort(this.compareAnnotations),s}count(e){return this.executeQuery(`${this.url}/fast/count`,e)}geoRange(e){return this.executeQuery(`${this.url}/fast/georange`,e)}depthHistogram(e,t=100){return this.executeQuery(`${this.url}/analysis/histogram/depth?size=${t}`,e)}timeHistogram(e,t=180){return this.executeQuery(`${this.url}/analysis/histogram/time?size=${t}`,e).then(s=>{const r=s.content,o=r.bins_min.map(a=>new Date(Date.parse(a))),u=r.bins_max.map(a=>new Date(Date.parse(a)));return{bins_min:o,bins_max:u,values:r.values}})}search(e){return this.executeQuery(`${this.url}/fast/`,e)}images(e){const t=`${this.url}/fast/concept/images/${encodeURIComponent(e)}?data=true`;return fetch(t,{mode:"cors"}).then(s=>s.json())}runUsingQuery(e){return fetch(`${this.url}/query/download`,{method:"POST",mode:"cors",body:JSON.stringify(e)}).then(t=>t.ok?t:Promise.reject(t)).then(t=>t.text().then(s=>s.split(`
`)).then(s=>s.map(i=>i.trim())).then(s=>s.filter(i=>i&&i!==""&&i!=="null")))}runUsingQueryWithTimeout(e,t){return fetch(`${this.url}/query/download`,{method:"POST",mode:"cors",body:JSON.stringify(e),signal:AbortSignal.timeout(t)}).then(s=>s.ok?s:Promise.reject(s)).then(s=>s.text().then(i=>i.split(`
`)).then(i=>i.map(r=>r.trim())).then(i=>i.filter(r=>r&&r!==""&&r!=="null")))}runUsingQueryWithAbortController(e,t){return fetch(`${this.url}/query/download`,{method:"POST",mode:"cors",body:JSON.stringify(e),signal:t.signal}).then(s=>s.ok?s:Promise.reject(s)).then(s=>s.text().then(i=>i.split(`
`)).then(i=>i.map(r=>r.trim())).then(i=>i.filter(r=>r&&r!==""&&r!=="null")))}countUsingQuery(e){return fetch(`${this.url}/query/count`,{method:"POST",mode:"cors",body:JSON.stringify(e)}).then(t=>t.ok?t.json():Promise.reject(t))}countUsingQueryWithTimeout(e,t){return fetch(`${this.url}/query/count`,{method:"POST",mode:"cors",body:JSON.stringify(e),signal:AbortSignal.timeout(t)}).then(s=>s.ok?s.json():Promise.reject(s))}countUsingQueryWithAbortController(e,t){return fetch(`${this.url}/query/count`,{method:"POST",mode:"cors",body:JSON.stringify(e),signal:t.signal}).then(s=>s.ok?s.json():Promise.reject(s))}async pageUsingQuery(e,t,s=()=>{}){s(0);const i=await this.runUsingQuery(e);return s(100),i}async pageUsingQueryWithTimeout(e,t,s=()=>{},i=()=>{},r){const o=new AbortController,u=setTimeout(()=>o.abort(),r);o.signal.addEventListener("abort",i),s(0);const m=await this.runUsingQueryWithAbortController(e,o);return clearTimeout(u),s(100),m}listQueryColumns(){return fetch(`${this.url}/query/columns`,{mode:"cors"}).then(e=>e.json())}listActivities(){return fetch(`${this.url}/observations/activities`,{mode:"cors"}).then(e=>e.json())}listGroups(){return fetch(`${this.url}/observations/groups`,{mode:"cors"}).then(e=>e.json())}listObservers(){const e={select:["observer"],distinct:!0,orderby:["observer"]};return this.runUsingQuery(e).then(t=>t.slice(1))}listChiefScientists(){const e={select:["chief_scientist"],distinct:!0,orderby:["chief_scientist"]};return this.runUsingQuery(e).then(t=>t.slice(1).sort())}}const se=c("annosaurus",()=>{const n=w(),e=p(()=>O("annosaurus",n.config)),t=p(()=>new X(e.value)),s=d(async()=>t.value.listActivities()),i=d(async()=>t.value.listGroups()),r=d(async()=>t.value.listObservers()),o=d(async()=>t.value.listChiefScientists()),u=d(async()=>(await t.value.listQueryColumns()).map(m=>m.columnName).sort());return{url:e,api:t,activities:s,groups:i,observers:r,chiefScientists:o,selectableColumns:u}});class ie{api;constructor(e){this.api=e}async runQuery(e=()=>{},t=()=>{},s=()=>{}){const i=this.buildQueries();if(i.length===0||i.every(u=>u.where===void 0||u.where.length===0))return t(),!1;const r=W();r.reset();let o=0;for(const u of i)await this.api.pageUsingQueryWithTimeout(u,5e5,e,s,J).then(a=>{o===0?r.appendRawQueryResults(a):r.appendRawQueryResults(a.slice(1)),o++}).catch(a=>{console.error(a)});return!0}buildQueries(){const e=y(),t=Y(),s=H(),i={select:t,where:s,distinct:!0,strict:!1,concurrentObservations:e.concurrentObservations,relatedAssociations:e.relatedAssociations},r=j(),o=r.buildColumnConstraints();return o.length>0?r.useAnd?(i.where.push(...o),[i]):o.map(u=>{const a=JSON.parse(JSON.stringify(i));return a.where.push(u),a}):[i]}}export{ie as Q,Z as a,k as b,g as c,C as d,se as e,Q as f,A as g,U as h,L as i,y as j,q as k,R as l,P as m,I as n,ne as r,j as u};

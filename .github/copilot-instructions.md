<!-- Copilot / AI agent instructions for vars-quickstart-mbari -->
# Quick instructions for AI coding agents

Purpose: concise, actionable guidance to get an AI coding agent productive in this repo.

- **Big picture:** This repository is a Docker-based quickstart/orchestrator for several MBARI microservices. `varsq` is the primary CLI (at the repo root) that merges environment files and runs `docker compose` inside `docker/`.

- **Key files & locations:**
  - `varsq` (root): main CLI. Subcommands: `configure`, `targets`, `docker`, `start`, `stop`, `build`, `update` — see [varsq](../varsq#L1-L200).
  - `etc/env/core.env`: canonical per-service env vars — see [etc/env/core.env](../etc/env/core.env#L1-L200).
  - `etc/env/original.env`: example/source env file — see [etc/env/original.env](../etc/env/original.env#L1-L200).
  - `docker/` (expected): working dir for `docker compose` and location for `docker/env.sh` created by `varsq configure`.

- **Environment merge & precedence (critical):**
  - `./varsq configure <source>` concatenates `<source>` first, then appends `etc/env/core.env` into `docker/env.sh`.
  - Because later shell `export` overrides earlier ones, variables in `core.env` win over the source file. Test any change to ordering before committing.
  - Example (exact):

```bash
./varsq configure etc/env/original.env
```

- **Common developer commands (copy-paste):**

```bash
chmod +x ./varsq                # make the CLI executable (if needed)
./varsq configure etc/env/original.env
./varsq targets                 # list available env files under etc/env/
./varsq start                   # runs `docker compose up -d` in docker/
./varsq stop                    # runs `docker compose down` in docker/
./varsq docker ps               # pass-through: runs `docker compose ps` inside docker/
./varsq update                  # pulls expected images
```

- **Notes about `docker/env.sh`:**
  - It is generated by `varsq configure`. The repo may also contain a checked-in `docker/env.sh` for convenience; validate its contents before using.
  - If `docker/` is missing, `varsq` will create it when running `configure`.

- **Service conventions & integration patterns:**
  - Services are represented by prefixed env vars (examples: `ANNOSAURUS_*`, `CHARYBDIS_*`, `ONI_*`, `PANOPTES_*`, `VAMPIRESQUID_*`). Inspect [etc/env/core.env](../etc/env/core.env#L1-L200) for concrete variables and default ports.
  - Internal service URLs use Docker hostnames (e.g. `http://annosaurus:8080`) — the compose network resolves those names.
  - ZeroMQ topics/ports appear in envs (e.g. `ANNOSAURUS_MESSAGING_ZEROMQ_PORT=5563`); integrations expect those to be reachable between containers.

- **Image list / update behavior:**
  - The `_update` subcommand pulls a set of images the quickstart expects (annosaurus, charybdis, oni, panoptes, raziel, vampire-squid, nginx, prom/prometheus, grafana/grafana-enterprise). Edit `_update` in `varsq` if you add/remove services.

- **Repository conventions to preserve when changing code:**
  - Env files are bash-style with `export VAR=value`. Keep quoting conventions and variable names stable.
  - Prefer small, focused edits: when renaming an env var, update all `etc/env/*` sources and any compose/service references together.

- **Security & secrets:**
  - Current env files use placeholder secrets. Never commit real production secrets. If adding test secrets, document where they are used and why.

- **When you (the AI) make changes:**
  - Run `./varsq configure` locally (or simulate by concatenating files) and inspect `docker/env.sh` before modifying services.
  - If adding services, add env var defaults to `etc/env/core.env` and update `_update` image list.
  - If you change how merges happen, add a clear test or a README note explaining the new precedence.

- **Where to look for quick context:**
  - `varsq` (root): orchestrator implementation — [varsq](../varsq#L1-L200)
  - `etc/env/original.env`: example environment — [etc/env/original.env](../etc/env/original.env#L1-L200)
  - `etc/env/core.env`: canonical env definitions — [etc/env/core.env](../etc/env/core.env#L1-L200)

If any part is unclear or you want a short `docker-compose.yml` walkthrough for the services, tell me which service(s) to target and I'll add it.
